name: "Build"
on:
  push:
  pull_request:

defaults:
  run:
    shell: bash

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - { title: "linux/analyze-build"   , host: "ubuntu-24.04"    , arch: "x64"    , cc: "clang-19", conf: "Debug"  , defs: "MATHPRESSO_TEST=0", diagnostics: "analyze-build"}
          - { title: "linux/asan"            , host: "ubuntu-24.04"    , arch: "x64"    , cc: "clang-19", conf: "Release", defs: "MATHPRESSO_TEST=1", diagnostics: "asan", }
          - { title: "linux/ubsan"           , host: "ubuntu-24.04"    , arch: "x64"    , cc: "clang-19", conf: "Release", defs: "MATHPRESSO_TEST=1", diagnostics: "ubsan", }
          - { title: "linux/hardened"        , host: "ubuntu-24.04"    , arch: "x64"    , cc: "clang-19", conf: "Release", defs: "MATHPRESSO_TEST=1", diagnostics: "hardened", }
          - { title: "linux/valgrind"        , host: "ubuntu-24.04"    , arch: "x64"    , cc: "clang-19", conf: "Release", defs: "MATHPRESSO_TEST=1", diagnostics: "valgrind", }
          - { title: "linux"                 , host: "ubuntu-24.04"    , arch: "x86"    , cc: "gcc-9"   , conf: "Debug"  , defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04"    , arch: "x86"    , cc: "gcc-9"   , conf: "Release", defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04"    , arch: "x64"    , cc: "gcc-9"   , conf: "Debug"  , defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04"    , arch: "x64"    , cc: "gcc-9"   , conf: "Release", defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04"    , arch: "x86"    , cc: "gcc-10"  , conf: "Debug"  , defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04"    , arch: "x86"    , cc: "gcc-10"  , conf: "Release", defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04"    , arch: "x64"    , cc: "gcc-10"  , conf: "Debug"  , defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04"    , arch: "x64"    , cc: "gcc-10"  , conf: "Release", defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04"    , arch: "x86"    , cc: "gcc-11"  , conf: "Debug"  , defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04"    , arch: "x86"    , cc: "gcc-11"  , conf: "Release", defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04"    , arch: "x64"    , cc: "gcc-11"  , conf: "Debug"  , defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04"    , arch: "x64"    , cc: "gcc-11"  , conf: "Release", defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04"    , arch: "x86"    , cc: "gcc-12"  , conf: "Debug"  , defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04"    , arch: "x86"    , cc: "gcc-12"  , conf: "Release", defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04"    , arch: "x64"    , cc: "gcc-12"  , conf: "Debug"  , defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04"    , arch: "x64"    , cc: "gcc-12"  , conf: "Release", defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04"    , arch: "x86"    , cc: "gcc-13"  , conf: "Debug"  , defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04"    , arch: "x86"    , cc: "gcc-13"  , conf: "Release", defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04"    , arch: "x64"    , cc: "gcc-13"  , conf: "Debug"  , defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04"    , arch: "x64"    , cc: "gcc-13"  , conf: "Release", defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04"    , arch: "x86"    , cc: "gcc-14"  , conf: "Debug"  , defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04"    , arch: "x86"    , cc: "gcc-14"  , conf: "Release", defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04"    , arch: "x64"    , cc: "gcc-14"  , conf: "Debug"  , defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04"    , arch: "x64"    , cc: "gcc-14"  , conf: "Release", defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04"    , arch: "x86"    , cc: "clang-14", conf: "Debug"  , defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04"    , arch: "x86"    , cc: "clang-14", conf: "Release", defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04"    , arch: "x64"    , cc: "clang-14", conf: "Debug"  , defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04"    , arch: "x64"    , cc: "clang-14", conf: "Release", defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04"    , arch: "x86"    , cc: "clang-15", conf: "Debug"  , defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04"    , arch: "x86"    , cc: "clang-15", conf: "Release", defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04"    , arch: "x64"    , cc: "clang-15", conf: "Debug"  , defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04"    , arch: "x64"    , cc: "clang-15", conf: "Release", defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04"    , arch: "x86"    , cc: "clang-16", conf: "Debug"  , defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04"    , arch: "x86"    , cc: "clang-16", conf: "Release", defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04"    , arch: "x64"    , cc: "clang-16", conf: "Debug"  , defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04"    , arch: "x64"    , cc: "clang-16", conf: "Release", defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04"    , arch: "x86"    , cc: "clang-17", conf: "Debug"  , defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04"    , arch: "x86"    , cc: "clang-17", conf: "Release", defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04"    , arch: "x64"    , cc: "clang-17", conf: "Debug"  , defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04"    , arch: "x64"    , cc: "clang-17", conf: "Release", defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04"    , arch: "x86"    , cc: "clang-18", conf: "Debug"  , defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04"    , arch: "x86"    , cc: "clang-18", conf: "Release", defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04"    , arch: "x64"    , cc: "clang-18", conf: "Debug"  , defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04"    , arch: "x64"    , cc: "clang-18", conf: "Release", defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04"    , arch: "x86"    , cc: "clang-19", conf: "Debug"  , defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04"    , arch: "x86"    , cc: "clang-19", conf: "Release", defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04"    , arch: "x64"    , cc: "clang-19", conf: "Debug"  , defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04"    , arch: "x64"    , cc: "clang-19", conf: "Release", defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04-arm", arch: "arm64"  , cc: "clang-19", conf: "Debug"  , defs: "MATHPRESSO_TEST=1" }
          - { title: "linux"                 , host: "ubuntu-24.04-arm", arch: "arm64"  , cc: "clang-19", conf: "Release", defs: "MATHPRESSO_TEST=1" }
          - { title: "macos"                 , host: "macos-15-intel"  , arch: "x64"    , cc: "gcc-14"  , conf: "Debug"  , defs: "MATHPRESSO_TEST=1" }
          - { title: "macos"                 , host: "macos-15-intel"  , arch: "x64"    , cc: "gcc-14"  , conf: "Release", defs: "MATHPRESSO_TEST=1" }
          - { title: "macos"                 , host: "macos-15-intel"  , arch: "x64"    , cc: "clang"   , conf: "Debug"  , defs: "MATHPRESSO_TEST=1" }
          - { title: "macos"                 , host: "macos-15-intel"  , arch: "x64"    , cc: "clang"   , conf: "Release", defs: "MATHPRESSO_TEST=1" }
          - { title: "macos"                 , host: "macos-15"        , arch: "arm64"  , cc: "clang"   , conf: "Debug"  , defs: "MATHPRESSO_TEST=1" }
          - { title: "macos"                 , host: "macos-15"        , arch: "arm64"  , cc: "clang"   , conf: "Release", defs: "MATHPRESSO_TEST=1" }
          - { title: "windows"               , host: "windows-2022"    , arch: "x86"    , cc: "vs2022"  , conf: "Debug"  , defs: "MATHPRESSO_TEST=1" }
          - { title: "windows"               , host: "windows-2022"    , arch: "x86"    , cc: "vs2022"  , conf: "Release", defs: "MATHPRESSO_TEST=1" }
          - { title: "windows"               , host: "windows-2022"    , arch: "x64"    , cc: "vs2022"  , conf: "Debug"  , defs: "MATHPRESSO_TEST=1" }
          - { title: "windows"               , host: "windows-2022"    , arch: "x64"    , cc: "vs2022"  , conf: "Release", defs: "MATHPRESSO_TEST=1" }
          - { title: "windows"               , host: "windows-11-arm"  , arch: "arm64"  , cc: "vs2022"  , conf: "Debug"  , defs: "MATHPRESSO_TEST=1" }
          - { title: "windows"               , host: "windows-11-arm"  , arch: "arm64"  , cc: "vs2022"  , conf: "Release", defs: "MATHPRESSO_TEST=1" }
          - { title: "freebsd"               , host: "ubuntu-latest"   , arch: "x64"    , cc: "clang"   , conf: "Release", vm: "freebsd", vm_ver: "14.2", defs: "MATHPRESSO_TEST=1" }
          - { title: "freebsd"               , host: "ubuntu-latest"   , arch: "arm64"  , cc: "clang"   , conf: "Release", vm: "freebsd", vm_ver: "14.2", defs: "MATHPRESSO_TEST=1" }
          - { title: "netbsd"                , host: "ubuntu-latest"   , arch: "x64"    , cc: "clang"   , conf: "Release", vm: "netbsd" , vm_ver: "10.1", defs: "MATHPRESSO_TEST=1" }
          - { title: "netbsd"                , host: "ubuntu-latest"   , arch: "arm64"  , cc: "clang"   , conf: "Release", vm: "netbsd" , vm_ver: "10.1", defs: "MATHPRESSO_TEST=1" }
          - { title: "openbsd"               , host: "ubuntu-latest"   , arch: "x64"    , cc: "clang"   , conf: "Release", vm: "openbsd", vm_ver: "7.4" , defs: "MATHPRESSO_TEST=1" }
          - { title: "openbsd"               , host: "ubuntu-latest"   , arch: "arm64"  , cc: "clang"   , conf: "Release", vm: "openbsd", vm_ver: "7.4" , defs: "MATHPRESSO_TEST=1" }

    name: "${{matrix.title}}/${{matrix.arch}}, ${{matrix.cc}} ${{matrix.conf}}"
    runs-on: "${{matrix.host}}"

    steps:
      - name: "Checkout MathPresso"
        uses: actions/checkout@v5
        with:
          path: "mathpresso"

      - name: "Checkout AsmJit"
        uses: actions/checkout@v5
        with:
          repository: asmjit/asmjit
          path: "asmjit"

      - name: "Checkout Build Actions"
        uses: actions/checkout@v5
        with:
          repository: build-actions/build-actions
          path: "build-actions"

      - name: "Python"
        uses: actions/setup-python@v6
        with:
          python-version: "3.x"

      - name: "Build & Test"
        if: ${{!matrix.vm}}
        run: python build-actions/action.py
               --step=all
               --compiler=${{matrix.cc}}
               --architecture=${{matrix.arch}}
               --source-dir=mathpresso
               --config=mathpresso/.github/workflows/build-config.json
               --build-type=${{matrix.conf}}
               --build-defs=${{matrix.defs}}

      - name: "Build & Test - Cross Platform Actions"
        if: ${{matrix.vm && matrix.vm_ver}}
        uses: cross-platform-actions/action@master
        with:
          operating_system: ${{matrix.vm}}
          architecture: ${{matrix.arch}}
          version: ${{matrix.vm_ver}}
          sync_files: "runner-to-vm"
          shutdown_vm: false
          shell: bash
          run: |
            set -e

            PATH="/usr/sbin:/usr/pkg/sbin:/usr/pkg/bin:$PATH:$(pwd)/build-actions"
            CI_NETBSD_USE_PKGIN=1

            export PATH
            export CI_NETBSD_USE_PKGIN

            sh ./build-actions/prepare-environment.sh
            python3 build-actions/action.py                           \
              --source-dir=mathpresso                                 \
              --config=mathpresso/.github/workflows/build-config.json \
              --compiler=${{matrix.cc}}                               \
              --diagnostics=${{matrix.diagnostics}}                   \
              --architecture=${{matrix.arch}}                         \
              --problem-matcher=auto                                  \
              --build-type=${{matrix.conf}}                           \
              --build-defs="${{matrix.defs}}"
